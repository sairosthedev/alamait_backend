const mongoose = require('mongoose');
require('dotenv').config();

// Connect to MongoDB
mongoose.connect(process.env.MONGODB_URI)
  .then(() => console.log('‚úÖ Connected to MongoDB'))
  .catch(err => console.error('‚ùå MongoDB connection error:', err));

// Import models
const TransactionEntry = require('../src/models/TransactionEntry');
const Debtor = require('../src/models/Debtor');

/**
 * INVESTIGATE STUDENT DISCREPANCY
 * 
 * You only have 6 students but system shows payments from 20+ students
 * This script will find out what's happening!
 */

async function investigateStudentDiscrepancy() {
  try {
    console.log('\nüö® INVESTIGATING STUDENT DISCREPANCY!');
    console.log('=====================================\n');
    
    // ========================================
    // STEP 1: COUNT ACTUAL STUDENTS
    // ========================================
    console.log('üìã STEP 1: COUNT ACTUAL STUDENTS');
    console.log('=================================\n');
    
    const debtors = await Debtor.find({});
    console.log(`üë• ACTUAL STUDENTS IN DEBTOR COLLECTION: ${debtors.length}`);
    
    if (debtors.length > 0) {
      console.log('\nüìä DEBTOR DETAILS:');
      console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
      console.log('‚îÇ Debtor Code‚îÇ Student  ‚îÇ Total Owed  ‚îÇ Total Paid  ‚îÇ Balance     ‚îÇ');
      console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');
      
      debtors.forEach(debtor => {
        const code = (debtor.debtorCode || 'N/A').padEnd(12);
        const student = (debtor.user ? 'Has User ID' : 'No User').padEnd(9);
        const owed = `$${(debtor.totalOwed || 0).toFixed(2)}`.padStart(12);
        const paid = `$${(debtor.totalPaid || 0).toFixed(2)}`.padStart(12);
        const balance = `$${(debtor.currentBalance || 0).toFixed(2)}`.padStart(12);
        
        console.log(`‚îÇ ${code} ‚îÇ ${student} ‚îÇ ${owed} ‚îÇ ${paid} ‚îÇ ${balance} ‚îÇ`);
      });
      
      console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n');
    }
    
    // ========================================
    // STEP 2: ANALYZE PAYMENT TRANSACTIONS
    // ========================================
    console.log('üìã STEP 2: ANALYZE PAYMENT TRANSACTIONS');
    console.log('========================================\n');
    
    const paymentEntries = await TransactionEntry.find({
      source: 'payment',
      'entries.accountCode': { $in: ['1001', '1002', '1011'] },
      status: 'posted'
    });
    
    console.log(`üí∞ PAYMENT TRANSACTIONS FOUND: ${paymentEntries.length}`);
    
    // Group by transaction ID to see how many unique payments
    const uniqueTransactions = new Set();
    const transactionDetails = {};
    
    paymentEntries.forEach(entry => {
      uniqueTransactions.add(entry.transactionId);
      
      if (!transactionDetails[entry.transactionId]) {
        transactionDetails[entry.transactionId] = {
          date: entry.date,
          sourceId: entry.sourceId,
          sourceModel: entry.sourceModel,
          metadata: entry.metadata,
          entries: []
        };
      }
      
      if (entry.entries && Array.isArray(entry.entries)) {
        entry.entries.forEach(lineItem => {
          if (['1001', '1002', '1011'].includes(lineItem.accountCode) && lineItem.debit > 0) {
            transactionDetails[entry.transactionId].entries.push({
              accountCode: lineItem.accountCode,
              amount: lineItem.debit,
              description: lineItem.description
            });
          }
        });
      }
    });
    
    console.log(`üîç UNIQUE PAYMENT TRANSACTIONS: ${uniqueTransactions.size}`);
    console.log(`üìä TOTAL CASH ENTRIES: ${paymentEntries.length}`);
    
    // ========================================
    // STEP 3: EXAMINE TRANSACTION STRUCTURE
    // ========================================
    console.log('\nüìã STEP 3: EXAMINE TRANSACTION STRUCTURE');
    console.log('==========================================\n');
    
    console.log('üîç SAMPLE TRANSACTION ANALYSIS:');
    console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
    console.log('‚îÇ Transaction ID                                 ‚îÇ Date        ‚îÇ Source ID   ‚îÇ Cash Entries‚îÇ');
    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');
    
    let count = 0;
    Object.entries(transactionDetails).forEach(([transactionId, details]) => {
      if (count < 10) { // Show first 10
        const txId = transactionId.padEnd(35);
        const date = details.date.toLocaleDateString().padEnd(12);
        const sourceId = (details.sourceId || 'N/A').toString().padEnd(12);
        const cashEntries = details.entries.length.toString().padEnd(12);
        
        console.log(`‚îÇ ${txId} ‚îÇ ${date} ‚îÇ ${sourceId} ‚îÇ ${cashEntries} ‚îÇ`);
        count++;
      }
    });
    
    if (Object.keys(transactionDetails).length > 10) {
      console.log('‚îÇ ... (showing first 10 of ' + Object.keys(transactionDetails).length + ' transactions) ‚îÇ');
    }
    
    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n');
    
    // ========================================
    // STEP 4: INVESTIGATE SOURCE IDs
    // ========================================
    console.log('üìã STEP 4: INVESTIGATE SOURCE IDs');
    console.log('==================================\n');
    
    const sourceIds = new Set();
    const sourceModels = new Set();
    
    paymentEntries.forEach(entry => {
      if (entry.sourceId) sourceIds.add(entry.sourceId.toString());
      if (entry.sourceModel) sourceModels.add(entry.sourceModel);
    });
    
    console.log(`üîç UNIQUE SOURCE IDs: ${sourceIds.size}`);
    console.log(`üìä SOURCE MODELS: ${Array.from(sourceModels).join(', ')}`);
    
    // Check if source IDs match debtor IDs
    const debtorIds = debtors.map(d => d._id.toString());
    const matchingSourceIds = Array.from(sourceIds).filter(id => debtorIds.includes(id));
    const nonMatchingSourceIds = Array.from(sourceIds).filter(id => !debtorIds.includes(id));
    
    console.log(`‚úÖ SOURCE IDs MATCHING DEBTORS: ${matchingSourceIds.length}`);
    console.log(`‚ùå SOURCE IDs NOT MATCHING DEBTORS: ${nonMatchingSourceIds.length}`);
    
    if (nonMatchingSourceIds.length > 0) {
      console.log('\nüö® NON-MATCHING SOURCE IDs (THESE ARE THE PROBLEM!):');
      nonMatchingSourceIds.slice(0, 10).forEach(id => {
        console.log(`   ‚Ä¢ ${id}`);
      });
      if (nonMatchingSourceIds.length > 10) {
        console.log(`   ‚Ä¢ ... and ${nonMatchingSourceIds.length - 10} more!`);
      }
    }
    
    // ========================================
    // STEP 5: CHECK FOR DUPLICATE ENTRIES
    // ========================================
    console.log('\nüìã STEP 5: CHECK FOR DUPLICATE ENTRIES');
    console.log('=========================================\n');
    
    // Check if the same transaction has multiple cash entries
    const duplicateTransactions = {};
    
    Object.entries(transactionDetails).forEach(([transactionId, details]) => {
      if (details.entries.length > 1) {
        duplicateTransactions[transactionId] = details;
      }
    });
    
    console.log(`üîÑ TRANSACTIONS WITH MULTIPLE CASH ENTRIES: ${Object.keys(duplicateTransactions).length}`);
    
    if (Object.keys(duplicateTransactions).length > 0) {
      console.log('\nüìä EXAMPLE OF DUPLICATE CASH ENTRIES:');
      const exampleTx = Object.entries(duplicateTransactions)[0];
      console.log(`   Transaction: ${exampleTx[0]}`);
      console.log(`   Date: ${exampleTx[1].date.toLocaleDateString()}`);
      exampleTx[1].entries.forEach(entry => {
        console.log(`   ‚Ä¢ Account ${entry.accountCode}: $${entry.amount.toFixed(2)} - ${entry.description}`);
      });
    }
    
    // ========================================
    // STEP 6: CALCULATE ACTUAL CASH RECEIVED
    // ========================================
    console.log('\nüìã STEP 6: CALCULATE ACTUAL CASH RECEIVED');
    console.log('============================================\n');
    
    let totalCashReceived = 0;
    let totalCashEntries = 0;
    
    paymentEntries.forEach(entry => {
      if (entry.entries && Array.isArray(entry.entries)) {
        entry.entries.forEach(lineItem => {
          if (['1001', '1002', '1011'].includes(lineItem.accountCode) && lineItem.debit > 0) {
            totalCashReceived += lineItem.debit;
            totalCashEntries++;
          }
        });
      }
    });
    
    console.log(`üí∞ TOTAL CASH RECEIVED: $${totalCashReceived.toFixed(2)}`);
    console.log(`üìä TOTAL CASH ENTRIES: ${totalCashEntries}`);
    console.log(`üîç UNIQUE TRANSACTIONS: ${uniqueTransactions.size}`);
    
    // ========================================
    // STEP 7: IDENTIFY THE PROBLEM
    // ========================================
    console.log('\nüìã STEP 7: IDENTIFY THE PROBLEM');
    console.log('==================================\n');
    
    console.log('üö® ROOT CAUSE ANALYSIS:');
    console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
    console.log('‚îÇ                                                                                             ‚îÇ');
    
    if (nonMatchingSourceIds.length > 0) {
      console.log('‚îÇ  üî¥ PROBLEM 1: ORPHANED TRANSACTIONS                                                      ‚îÇ');
      console.log('‚îÇ     ‚Ä¢ You have ${nonMatchingSourceIds.length} payment transactions with source IDs that don\'t match your debtors ‚îÇ');
      console.log('‚îÇ     ‚Ä¢ These are likely from deleted students or test data                                ‚îÇ');
      console.log('‚îÇ     ‚Ä¢ They\'re inflating your cash received total                                          ‚îÇ');
    }
    
    if (Object.keys(duplicateTransactions).length > 0) {
      console.log('‚îÇ  üî¥ PROBLEM 2: DUPLICATE CASH ENTRIES                                                     ‚îÇ');
      console.log('‚îÇ     ‚Ä¢ Some transactions have multiple cash account entries                                ‚îÇ');
      console.log('‚îÇ     ‚Ä¢ This could be double-counting the same payment                                      ‚îÇ');
    }
    
    if (totalCashEntries > uniqueTransactions.size) {
      console.log('‚îÇ  üî¥ PROBLEM 3: OVER-COUNTING                                                              ‚îÇ');
      console.log('‚îÇ     ‚Ä¢ ${totalCashEntries} cash entries vs ${uniqueTransactions.size} unique transactions    ‚îÇ');
      console.log('‚îÇ     ‚Ä¢ Each payment should only have ONE cash entry                                        ‚îÇ');
    }
    
    console.log('‚îÇ                                                                                             ‚îÇ');
    console.log('‚îÇ  üí° SOLUTION: Clean up orphaned transactions and fix duplicate entries                      ‚îÇ');
    console.log('‚îÇ                                                                                             ‚îÇ');
    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n');
    
    // ========================================
    // FINAL SUMMARY
    // ========================================
    console.log('üéØ FINAL SUMMARY');
    console.log('================\n');
    
    console.log('‚úÖ WHAT WE CONFIRMED:');
    console.log(`   ‚Ä¢ You actually have ${debtors.length} students (correct)`);
    console.log(`   ‚Ä¢ System shows ${uniqueTransactions.size} payment transactions`);
    console.log(`   ‚Ä¢ Total cash entries: ${totalCashEntries}`);
    console.log(`   ‚Ä¢ Total cash received: $${totalCashReceived.toFixed(2)}`);
    
    console.log('\nüö® THE PROBLEM:');
    console.log('   ‚Ä¢ You have orphaned payment transactions from deleted/test students');
    console.log('   ‚Ä¢ These transactions are inflating your cash received total');
    console.log('   ‚Ä¢ The $5,420.00 includes payments from students who no longer exist');
    
    console.log('\nüîß WHAT TO DO:');
    console.log('   1. Clean up orphaned transactions');
    console.log('   2. Verify only current students have payment records');
    console.log('   3. Reconcile actual cash received with your 6 students');
    
    console.log('\nüéâ INVESTIGATION COMPLETE!');
    
  } catch (error) {
    console.error('‚ùå Error investigating student discrepancy:', error);
  } finally {
    await mongoose.disconnect();
    console.log('\nüîå Disconnected from MongoDB');
  }
}

// Run the investigation
investigateStudentDiscrepancy();
