# üè¢ **Vendor System Implementation Guide**

## üìã **Overview**

The vendor system in the Alamait backend provides comprehensive vendor management with automatic vendor creation from request quotations. This system integrates with the request-to-payment flow and includes chart of accounts integration.

## üóÑÔ∏è **Database Schema**

### **Vendor Model (`src/models/Vendor.js`)**

```javascript
{
  _id: ObjectId,
  vendorCode: String,               // Auto-generated unique code (e.g., "V25001")
  businessName: String,             // Legal business name
  tradingName: String,              // Trading name
  
  // Contact Information
  contactPerson: {
    firstName: String,
    lastName: String,
    email: String,
    phone: String,
    mobile: String
  },
  
  // Business Address
  businessAddress: {
    street: String,
    city: String,
    state: String,
    province: String,
    postalCode: String,
    country: String
  },
  
  // Tax and Registration
  taxNumber: String,
  vatNumber: String,
  registrationNumber: String,
  
  // Chart of Accounts Integration
  chartOfAccountsCode: String,      // AP account code (e.g., "200001")
  expenseAccountCode: String,       // Legacy field
  expenseCategory: String,          // 'maintenance_expenses' | 'utilities_expenses' | etc.
  
  // Banking Information
  bankDetails: {
    bankName: String,
    accountNumber: String,
    accountType: String,
    branchCode: String,
    swiftCode: String
  },
  defaultPaymentMethod: String,     // 'Cash' | 'Bank Transfer'
  
  // Business Classification
  category: String,                 // 'maintenance' | 'utilities' | 'supplies' | etc.
  vendorType: String,               // 'shop' | 'contractor' | 'service_provider' | 'other'
  businessScope: String,            // Description of vendor specialization
  
  // Specializations and Service Areas
  specializations: [String],
  serviceAreas: [String],
  
  // Status and Performance
  status: String,                   // 'active' | 'inactive' | 'suspended' | 'blacklisted'
  rating: Object,
  performance: Object,
  
  // Financial Information
  creditLimit: Number,
  currentBalance: Number,
  paymentTerms: Number,
  
  // Documents
  documents: [{
    type: String,
    name: String,
    url: String,
    uploadedAt: Date,
    uploadedBy: ObjectId
  }],
  
  // Notes
  notes: String,
  
  // Auto-generation flag
  isAutoGenerated: Boolean,         // true for auto-created vendors
  
  // Audit Trail
  createdBy: ObjectId,
  updatedBy: ObjectId,
  
  // History
  history: [{
    action: String,
    description: String,
    user: ObjectId,
    timestamp: Date,
    changes: [{
      field: String,
      oldValue: Mixed,
      newValue: Mixed
    }]
  }],
  
  createdAt: Date,
  updatedAt: Date
}
```

## üîå **API Endpoints**

### **Vendor Management Routes (`src/routes/vendorRoutes.js`)**

#### **1. Create Vendor**
```http
POST /api/vendors
Authorization: Bearer <token>
Content-Type: application/json

{
  "businessName": "ABC Plumbing Services",
  "tradingName": "ABC Plumbing",
  "contactPerson": {
    "firstName": "John",
    "lastName": "Smith",
    "email": "john@abcplumbing.com",
    "phone": "+27 11 123 4567"
  },
  "businessAddress": {
    "street": "123 Main Street",
    "city": "Johannesburg",
    "province": "Gauteng",
    "postalCode": "2000",
    "country": "South Africa"
  },
  "category": "plumbing",
  "vendorType": "contractor",
  "businessScope": "Plumbing services and repairs"
}
```

#### **2. Get All Vendors**
```http
GET /api/vendors?page=1&limit=10&category=plumbing&status=active&search=plumbing
Authorization: Bearer <token>
```

#### **3. Get Vendors for Quotations**
```http
GET /api/vendors/for-quotations?category=plumbing&search=ABC
Authorization: Bearer <token>
```

#### **4. Search Vendors**
```http
GET /api/vendors/search?query=plumbing&category=plumbing&limit=10
Authorization: Bearer <token>
```

#### **5. Get Vendor by ID**
```http
GET /api/vendors/:id
Authorization: Bearer <token>
```

#### **6. Update Vendor**
```http
PUT /api/vendors/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "businessName": "Updated Business Name",
  "contactPerson": {
    "phone": "+27 11 987 6543"
  }
}
```

#### **7. Update Vendor Performance**
```http
PATCH /api/vendors/:id/performance
Authorization: Bearer <token>
Content-Type: application/json

{
  "responseTime": 24,
  "onTime": true,
  "qualityRating": 4.5,
  "completed": true
}
```

#### **8. Delete Vendor (Soft Delete)**
```http
DELETE /api/vendors/:id
Authorization: Bearer <token>
```

#### **9. Get Creditors (Vendors)**
```http
GET /api/vendors/creditors?status=active&search=plumbing&page=1&limit=10
Authorization: Bearer <token>
```

#### **10. Get Creditor Summary**
```http
GET /api/vendors/creditors/:vendorId/summary
Authorization: Bearer <token>
```

## ü§ñ **Auto-Vendor Creation System**

### **How It Works**

The auto-vendor creation system automatically creates vendors when quotations are uploaded to requests. This happens in the following scenarios:

1. **Request Creation**: When items have quotations with new provider names
2. **Quotation Upload**: When uploading quotations with new provider names
3. **Item Quotation Addition**: When adding quotations to specific items

### **Auto-Creation Logic (`src/controllers/requestController.js`)**

```javascript
async function autoCreateVendor(providerName, user, category = 'other') {
    try {
        // 1. Check if vendor already exists
        const existingVendor = await Vendor.findOne({ 
            businessName: { $regex: new RegExp(providerName, 'i') } 
        });
        
        if (existingVendor) {
            return existingVendor;
        }

        // 2. Generate unique chart of accounts code
        const vendorCount = await Vendor.countDocuments();
        const chartOfAccountsCode = `200${(vendorCount + 1).toString().padStart(3, '0')}`;
        
        // 3. Map category to expense category
        const categoryExpenseMap = {
            'maintenance': 'maintenance_expenses',
            'utilities': 'utilities_expenses',
            'supplies': 'supplies_expenses',
            'equipment': 'equipment_expenses',
            'services': 'services_expenses',
            'cleaning': 'cleaning_expenses',
            'security': 'security_expenses',
            'landscaping': 'landscaping_expenses',
            'electrical': 'electrical_expenses',
            'plumbing': 'plumbing_expenses',
            'carpentry': 'carpentry_expenses',
            'painting': 'painting_expenses',
            'other': 'other_expenses'
        };
        const expenseCategory = categoryExpenseMap[category] || 'other_expenses';
        
        // 4. Determine vendor type based on category
        let vendorType = 'other';
        if (category === 'supplies' || category === 'equipment') {
            vendorType = 'shop';
        } else if (['maintenance', 'cleaning', 'security', 'landscaping', 'electrical', 'plumbing', 'carpentry', 'painting'].includes(category)) {
            vendorType = 'contractor';
        } else if (category === 'services') {
            vendorType = 'service_provider';
        }

        // 5. Create vendor data
        const vendorData = {
            businessName: providerName,
            tradingName: providerName,
            contactPerson: {
                firstName: 'Auto',
                lastName: 'Generated',
                email: `auto-${Date.now()}@vendor.local`,
                phone: '+27 00 000 0000'
            },
            businessAddress: {
                street: 'Auto-generated address',
                city: 'Johannesburg',
                province: 'Gauteng',
                postalCode: '0000',
                country: 'South Africa'
            },
            category: category,
            vendorType: vendorType,
            businessScope: `${vendorType} specializing in ${category} services/products`,
            chartOfAccountsCode: chartOfAccountsCode,
            expenseCategory: expenseCategory,
            bankDetails: {
                bankName: null,
                accountNumber: null,
                accountType: null,
                branchCode: null,
                swiftCode: null
            },
            defaultPaymentMethod: 'Cash',
            createdBy: user._id,
            isAutoGenerated: true,
            history: [{
                action: 'Vendor auto-created',
                description: `Vendor auto-created from request quotation: ${providerName}`,
                user: user._id,
                changes: ['Auto-generated from quotation', 'Payment method: Cash (no bank details)']
            }]
        };

        // 6. Save vendor and create chart of accounts entries
        const vendor = new Vendor(vendorData);
        const savedVendor = await vendor.save();
        await ensureChartOfAccountsEntries(chartOfAccountsCode, savedVendor);
        
        return savedVendor;

    } catch (error) {
        console.error('Error auto-creating vendor:', error);
        throw error;
    }
}
```

### **Vendor Type Mapping**

| Category | Vendor Type | Business Scope |
|----------|-------------|----------------|
| `supplies`, `equipment` | `shop` | shop specializing in supplies/equipment services/products |
| `maintenance`, `cleaning`, `security`, `landscaping`, `electrical`, `plumbing`, `carpentry`, `painting` | `contractor` | contractor specializing in [category] services/products |
| `services` | `service_provider` | service_provider specializing in services services/products |
| `other` | `other` | other specializing in other services/products |

### **Payment Method Logic**

```javascript
function determinePaymentMethod(vendor) {
    // Check if vendor has bank details
    if (vendor.bankDetails && vendor.bankDetails.bankName) {
        return 'Bank Transfer';
    }
    
    // Check if vendor has specific payment method preference
    if (vendor.defaultPaymentMethod) {
        return vendor.defaultPaymentMethod;
    }
    
    // Default to cash for auto-generated vendors without bank details
    return 'Cash';
}
```

## üîÑ **Integration with Request System**

### **Request Creation Flow**

1. **Create Request**: User creates a request with items and proposed vendor
2. **Upload Quotation**: Admin uploads quotation with provider name
3. **Auto-Vendor Creation**: System automatically creates vendor if provider doesn't exist
4. **Vendor Linking**: Quotation is linked to the vendor with all vendor details
5. **Payment Method**: System determines payment method based on vendor details

### **Quotation Schema with Vendor Information**

```javascript
{
  _id: ObjectId,
  provider: String,
  amount: Number,
  description: String,
  fileUrl: String,
  fileName: String,
  uploadedBy: ObjectId,
  uploadedAt: Date,
  isApproved: Boolean,
  approvedBy: ObjectId,
  approvedAt: Date,
  
  // Auto-linked vendor information
  vendorId: ObjectId,
  vendorCode: String,
  vendorName: String,
  vendorType: String,
  vendorContact: {
    firstName: String,
    lastName: String,
    email: String,
    phone: String
  },
  expenseCategory: String,
  paymentMethod: String,
  hasBankDetails: Boolean
}
```

## üß™ **Testing the System**

### **Test Script (`test-vendor-auto-creation.js`)**

Run the comprehensive test to verify the vendor auto-creation system:

```bash
node test-vendor-auto-creation.js
```

This test will:
1. Login to the system
2. Check existing vendors
3. Create a request with items
4. Upload a quotation (triggers auto-vendor creation)
5. Verify vendor was created
6. Check vendor details and payment method

### **Manual Testing Steps**

1. **Create Request**:
   ```bash
   curl -X POST http://localhost:3000/api/requests \
     -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d '{
       "title": "Office Supplies Purchase",
       "description": "Need office supplies",
       "type": "operational",
       "residence": "507f1f77bcf86cd799439011",
       "department": "Administration",
       "requestedBy": "John Doe",
       "items": [{"description": "Paper", "quantity": 10, "unitCost": 25}],
       "proposedVendor": "ABC Supplies"
     }'
   ```

2. **Upload Quotation**:
   ```bash
   curl -X POST http://localhost:3000/api/requests/<requestId>/quotations \
     -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d '{
       "provider": "ABC Supplies",
       "amount": 250,
       "description": "Office supplies quotation"
     }'
   ```

3. **Check Vendors**:
   ```bash
   curl -X GET http://localhost:3000/api/vendors \
     -H "Authorization: Bearer <token>"
   ```

## üîß **Configuration and Setup**

### **Required Dependencies**

The vendor system requires the following models to be properly set up:

1. **Vendor Model**: `src/models/Vendor.js`
2. **Account Model**: `src/models/Account.js` (for chart of accounts)
3. **User Model**: `src/models/User.js` (for audit trail)

### **Middleware Requirements**

- **Authentication**: All vendor routes require authentication
- **Role-based Access**: Admin and Finance roles can access vendor management
- **File Upload**: For quotation documents (if using file uploads)

### **Database Indexes**

The vendor model includes the following indexes for performance:

```javascript
vendorSchema.index({ vendorCode: 1 });
vendorSchema.index({ businessName: 1 });
vendorSchema.index({ 'contactPerson.email': 1 });
vendorSchema.index({ category: 1 });
vendorSchema.index({ status: 1 });
vendorSchema.index({ chartOfAccountsCode: 1 });
```

## üöÄ **Usage Examples**

### **Frontend Integration**

```javascript
// Get vendors for quotation dropdown
const getVendorsForQuotations = async (category) => {
  const response = await fetch(`/api/vendors/for-quotations?category=${category}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  return response.json();
};

// Search vendors
const searchVendors = async (query) => {
  const response = await fetch(`/api/vendors/search?query=${encodeURIComponent(query)}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  return response.json();
};

// Create vendor manually
const createVendor = async (vendorData) => {
  const response = await fetch('/api/vendors', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(vendorData)
  });
  return response.json();
};
```

### **Backend Integration**

```javascript
// In request controller - auto-create vendor
const vendor = await autoCreateVendor(quotation.provider, user, vendorCategory);

// Update quotation with vendor information
quotation.vendorId = vendor._id;
quotation.vendorCode = vendor.chartOfAccountsCode;
quotation.vendorName = vendor.businessName;
quotation.vendorType = vendor.vendorType;
quotation.paymentMethod = determinePaymentMethod(vendor);
quotation.hasBankDetails = !!(vendor.bankDetails && vendor.bankDetails.bankName);
```

## üìä **Monitoring and Maintenance**

### **Vendor Performance Tracking**

The system automatically tracks vendor performance metrics:

- **Response Time**: Average time to respond to requests
- **On-time Delivery**: Percentage of on-time deliveries
- **Quality Rating**: Average quality rating from reviews
- **Total Orders**: Number of orders processed
- **Completed Orders**: Number of successfully completed orders

### **Audit Trail**

All vendor changes are tracked in the history array:

```javascript
{
  action: 'Vendor updated',
  description: 'Vendor information modified',
  user: ObjectId,
  timestamp: Date,
  changes: [{
    field: 'businessName',
    oldValue: 'Old Name',
    newValue: 'New Name'
  }]
}
```

### **Auto-Generated Vendors**

Auto-generated vendors are flagged with `isAutoGenerated: true` and can be:

1. **Updated**: Add real contact information and bank details
2. **Merged**: Combine with existing vendors if duplicates are found
3. **Deactivated**: If vendor is no longer needed

## üîí **Security Considerations**

1. **Role-based Access**: Only admin and finance users can manage vendors
2. **Input Validation**: All vendor data is validated before saving
3. **Audit Trail**: All changes are logged with user information
4. **Soft Delete**: Vendors are deactivated rather than deleted
5. **Bank Details**: Sensitive banking information is properly handled

## üéØ **Best Practices**

1. **Vendor Naming**: Use consistent naming conventions for vendors
2. **Category Assignment**: Properly categorize vendors for better organization
3. **Bank Details**: Add bank details for vendors that accept bank transfers
4. **Performance Tracking**: Regularly update vendor performance metrics
5. **Documentation**: Keep vendor documents and certificates up to date
6. **Regular Review**: Periodically review and clean up vendor database

## üö® **Troubleshooting**

### **Common Issues**

1. **Vendor Not Auto-Created**: Check if provider name already exists
2. **Payment Method Issues**: Verify vendor has bank details for bank transfers
3. **Chart of Accounts Errors**: Ensure Account model is properly set up
4. **Permission Errors**: Verify user has admin or finance role

### **Debug Steps**

1. Check server logs for auto-creation errors
2. Verify vendor model schema matches expected fields
3. Test vendor creation manually
4. Check database indexes are properly created
5. Verify chart of accounts integration

---

This vendor system provides a complete solution for vendor management with automatic creation, comprehensive tracking, and seamless integration with the request-to-payment flow. 