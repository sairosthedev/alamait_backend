# Auto-Vendor Creation Feature - Complete Implementation

## üéØ **Overview**

The enhanced request system now automatically creates vendor records when submitting requests with new vendor names in quotations. This feature eliminates the need for manual vendor creation and ensures proper financial integration with the chart of accounts.

## üîÑ **How It Works**

### **1. Automatic Detection**
When a request is submitted with quotations containing new vendor names, the system:

1. **Checks if vendor exists** by business name (case-insensitive search)
2. **Auto-creates vendor** if not found
3. **Generates single chart of accounts code** for vendor-specific AP account
4. **Determines vendor type** (shop, contractor, service provider)
5. **Links quotation to vendor** with proper vendor ID and financial codes
6. **Creates vendor-specific AP account** in chart of accounts

### **2. Trigger Points**
Auto-vendor creation is triggered in three scenarios:

#### **A. Enhanced Request Creation**
```javascript
POST /api/requests
{
    "title": "Office Equipment Purchase",
    "type": "operational",
    "items": [
        {
            "description": "HP LaserJet Printer",
            "quotations": [
                {
                    "provider": "ABC Office Supplies",  // ‚Üê Auto-creates vendor
                    "amount": 500,
                    "description": "Best price available"
                }
            ]
        }
    ]
}
```

#### **B. Request-Level Quotation Upload**
```javascript
POST /api/requests/:id/quotations
{
    "provider": "XYZ Services",  // ‚Üê Auto-creates vendor
    "amount": 1000,
    "description": "Professional service"
}
```

#### **C. Item-Level Quotation Upload**
```javascript
POST /api/requests/:id/items/:itemIndex/quotations
{
    "provider": "DEF Contractors",  // ‚Üê Auto-creates vendor
    "amount": 750,
    "description": "Quality work guaranteed"
}
```

## üè∑Ô∏è **Auto-Generated Vendor Data**

### **Basic Information**
```javascript
{
    businessName: "Provider Name",           // From quotation provider
    tradingName: "Provider Name",            // Same as business name
    category: "auto-detected",               // Based on request/item description
    vendorType: "shop|contractor|service_provider|other", // Vendor type
    businessScope: "vendor_type specializing in category services/products",
    isAutoGenerated: true,                   // Flag for identification
}
```

### **Contact Information**
```javascript
contactPerson: {
    firstName: "Auto",
    lastName: "Generated",
    email: "auto-{timestamp}@vendor.local",  // Auto-generated email
    phone: "+27 00 000 0000"                 // Placeholder phone
}
```

### **Address Information**
```javascript
businessAddress: {
    street: "Auto-generated address",
    city: "Johannesburg",
    province: "Gauteng",
    postalCode: "0000",
    country: "South Africa"
}
```

### **Chart of Accounts Code**
```javascript
chartOfAccountsCode: "200001",              // Single vendor-specific AP account
expenseCategory: "maintenance_expenses",     // Category for expense tracking
```

## üóÇÔ∏è **Vendor Type Classification**

The system automatically determines vendor types based on category:

### **Vendor Types**
- **`shop`**: Supplies, equipment vendors
- **`contractor`**: Maintenance, cleaning, security, landscaping, electrical, plumbing, carpentry, painting
- **`service_provider`**: General services
- **`other`**: Default for unknown categories

### **Category Detection Logic**

#### **Request Type**
- `maintenance` ‚Üí Category: `maintenance`

#### **Item Description Keywords**
- `plumbing`, `pipe`, `drain` ‚Üí Category: `plumbing`
- `electrical`, `wiring`, `power` ‚Üí Category: `electrical`
- `cleaning`, `clean` ‚Üí Category: `cleaning`
- `security`, `guard` ‚Üí Category: `security`
- `landscaping`, `garden` ‚Üí Category: `landscaping`
- Default ‚Üí Category: `other`

### **Category to Expense Category Mapping**
```javascript
{
    'maintenance': 'maintenance_expenses',
    'utilities': 'utilities_expenses',
    'supplies': 'supplies_expenses',
    'equipment': 'equipment_expenses',
    'services': 'services_expenses',
    'cleaning': 'cleaning_expenses',
    'security': 'security_expenses',
    'landscaping': 'landscaping_expenses',
    'electrical': 'electrical_expenses',
    'plumbing': 'plumbing_expenses',
    'carpentry': 'carpentry_expenses',
    'painting': 'painting_expenses',
    'other': 'other_expenses'
}
```

## üìä **Chart of Accounts Integration**

### **Single Vendor Account Creation**
When a vendor is auto-created, the system creates only ONE chart of accounts entry:

**Vendor-Specific Accounts Payable Account:**
```javascript
{
    code: "200001",                    // Auto-generated vendor code
    name: "Accounts Payable - Vendor Name",
    type: "Liability"
}
```

### **Expense Tracking**
- Uses existing chart of accounts structure
- `expenseCategory` field identifies which expense account to use
- No duplicate expense accounts created per vendor

## üîó **Quotation-Vendor Linking**

After auto-creating a vendor, quotations are automatically linked with:

```javascript
{
    provider: "Vendor Name",
    amount: 500,
    vendorId: "vendor_object_id",         // ‚Üê Auto-linked
    vendorCode: "200001",                 // ‚Üê Auto-linked (chartOfAccountsCode)
    vendorName: "Vendor Name",            // ‚Üê Auto-linked
    vendorType: "contractor",             // ‚Üê Auto-linked
    vendorContact: {                      // ‚Üê Auto-linked
        firstName: "Auto",
        lastName: "Generated",
        email: "auto-123@vendor.local",
        phone: "+27 00 000 0000"
    },
    expenseCategory: "maintenance_expenses" // ‚Üê Auto-linked
}
```

## üõ°Ô∏è **Error Handling**

### **Graceful Degradation**
- If vendor creation fails, the request/quotation upload continues
- No request is blocked due to vendor creation issues
- Errors are logged but don't affect the main workflow

### **Duplicate Prevention**
- Checks for existing vendors by business name before creation
- Case-insensitive matching prevents duplicates
- Returns existing vendor if found

## üìù **Usage Examples**

### **Example 1: Enhanced Request with Auto-Vendor Creation**
```javascript
POST /api/requests
{
    "title": "Plumbing Repair",
    "description": "Fix blocked drain in Unit 101",
    "type": "operational",
    "department": "Maintenance",
    "requestedBy": "Admin User",
    "deliveryLocation": "Unit 101",
    "items": [
        {
            "description": "Fix blocked drain",
            "quantity": 1,
            "unitCost": 500,
            "quotations": [
                {
                    "provider": "ABC Plumbing Services",  // ‚Üê Auto-creates vendor
                    "amount": 500,
                    "description": "Professional service"
                }
            ]
        }
    ]
}
```

**Result:**
- Vendor "ABC Plumbing Services" is auto-created
- Category: `plumbing`
- Vendor Type: `contractor`
- Chart of accounts code: `200001` (vendor-specific AP account)
- Expense Category: `plumbing_expenses`
- Quotation is linked to the new vendor

### **Example 2: Shop Vendor Creation**
```javascript
POST /api/requests/:id/quotations
Content-Type: multipart/form-data

{
    "provider": "XYZ Office Supplies",  // ‚Üê Auto-creates shop vendor
    "amount": 1200,
    "description": "Office equipment and supplies",
    "quotation": [file]
}
```

**Result:**
- Vendor "XYZ Office Supplies" is auto-created
- Category: `supplies`
- Vendor Type: `shop`
- Chart of accounts code: `200002` (vendor-specific AP account)
- Expense Category: `supplies_expenses`
- Quotation is linked to the new vendor

## üîç **Monitoring and Management**

### **Auto-Generated Vendor Identification**
```javascript
// Check if vendor was auto-generated
const isAutoGenerated = vendor.isAutoGenerated === true;

// Find all auto-generated vendors
const autoVendors = await Vendor.find({ isAutoGenerated: true });

// Find vendors by type
const shopVendors = await Vendor.find({ vendorType: 'shop' });
const contractorVendors = await Vendor.find({ vendorType: 'contractor' });
```

### **Vendor History Tracking**
```javascript
history: [{
    action: "Vendor auto-created",
    description: "Vendor auto-created from request quotation: Vendor Name",
    user: "user_id",
    changes: ["Auto-generated from quotation"]
}]
```

## üéØ **Benefits**

1. **Seamless Workflow**: No interruption to request submission process
2. **Financial Integration**: Single vendor-specific AP account per vendor
3. **Vendor Type Classification**: Clear distinction between shops, contractors, and service providers
4. **Duplicate Prevention**: Smart vendor detection and linking
5. **Category Intelligence**: Automatic category detection from context
6. **Error Resilience**: Graceful handling of vendor creation issues
7. **Audit Trail**: Complete history tracking for auto-generated vendors

## üöÄ **Future Enhancements**

1. **Vendor Data Enrichment**: Allow updating auto-generated vendor details
2. **Smart Category Detection**: Enhanced keyword analysis for better categorization
3. **Vendor Performance Tracking**: Monitor auto-generated vendor performance
4. **Bulk Vendor Management**: Tools for managing auto-generated vendors
5. **Integration with External APIs**: Pull vendor data from business directories

---

## üìã **API Endpoints Summary**

| Endpoint | Method | Auto-Vendor Creation | Description |
|----------|--------|---------------------|-------------|
| `/api/requests` | POST | ‚úÖ | Enhanced request creation |
| `/api/requests/:id/quotations` | POST | ‚úÖ | Request-level quotation upload |
| `/api/requests/:id/items/:itemIndex/quotations` | POST | ‚úÖ | Item-level quotation upload |

The auto-vendor creation feature is now fully integrated into the enhanced request system, providing seamless vendor management with proper type classification and single chart of accounts integration! üéØ 